<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Windows Kills SMB Speeds When Using Tailscale | Dan [the] Salmon</title><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Posts" href=/posts/index.xml><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Links" href=/links/index.xml><link rel=me href=https://infosec.exchange/@dan name=Mastodon><link rel=me href=https://github.com/sa7mon name=GitHub><link rel=stylesheet href=/combined.min.a5fe1913713a5e577355cad1fe1240b37249c2f949298b40b20c33e509bdae1e.css integrity="sha256-pf4ZE3E6XldzVcrR/hJAs3JJwvlJKYtAsgwz5Qm9rh4=" crossorigin=anonymous></head><body><header><div class=header-container><a class=brand href=/>Dan [the] Salmon</a><nav><ul><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/links/>Links</a></li><li><a href=/contact/>Contact</a></li></ul></nav></div></header><main class=page><time class=pub-date datetime=2024-11-11T00:00:00+00:00>November 11, 2024</time><h1 class=title>Windows Kills SMB Speeds When Using Tailscale</h1><div class=tags><a href=/tags/windows/>Windows</a>
<a href=/tags/tailscale/>Tailscale</a></div><h3 id=the-issue>The Issue</h3><p>Yesterday when trying to transfer an ISO file from a TrueNAS SMB share, I was getting horrible transfer speeds.</p><figure><img src=/posts/windows-smb-tailscale/slow1.png alt="Copy progress dialog window showing a speed of 355KB/s"></figure><p>The NAS can definitely saturate a gigabit link which is what my desktop connects to the switch over. I had seen this behavior before and had a feeling it was related to having Tailscale running - the last time it happened I quit Tailscale and my fast transfers returned.</p><p>Why would this matter?</p><p>Well, in my home network I have a Proxmox VM that, among other things, runs Tailscale as a <a href=https://tailscale.com/kb/1019/subnets>subnet router</a>. I set it up this way so that my homelab services (especially Pi-hole) are available to my laptop and phone from outside my house.</p><p>Consequently, my desktop now has 2 interfaces that can both reach my trusted <code>10.10.1.1/24</code> network - the gigabit NIC connected to the switch and the Tailscale virtual adapter.</p><p>A quick online search led me to a thread <a href=https://forum.tailscale.com/t/windows-routes-all-smb-traffic-through-tailscale-even-when-lan-ip-is-specified-is-much-slower/1995>on the Tailscale forums</a> describing the exact behavior I was seeing.</p><p>I learned that Windows has a system for determining which interface will handle a request when multiple interfaces could be used. Just like dynamic routing protocols calculate the &ldquo;cost&rdquo; of each route to a remote network, Windows has a system to calculate which interface to use. Windows refers to this cost as the &ldquo;Interface Metric&rdquo; which is calculated based on the physical interface medium and its link speed (as documented <a href=https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/automatic-metric-for-ipv4-routes>here</a> in the last table).</p><p>Since the Tailscale interface advertises a link speed of 100Gbps, Windows assigns it a much lower interface metric than the integrated gigabit NIC on my motherboard. Lower metric = lower &ldquo;cost&rdquo; associated.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\&gt;</span> <span class=nb>Get-NetAdapter</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-EQ</span> <span class=s2>&#34;Tailscale&#34;</span> <span class=o>-or</span> <span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-EQ</span> <span class=s2>&#34;Ethernet&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Name</span>        <span class=n>InterfaceDescription</span>     <span class=n>ifIndex</span> <span class=n>Status</span>   <span class=n>LinkSpeed</span>
</span></span><span class=line><span class=cl><span class=p>----</span>        <span class=p>--------------------</span>     <span class=p>-------</span> <span class=p>------</span>   <span class=p>---------</span>
</span></span><span class=line><span class=cl><span class=n>Ethernet</span>    <span class=n>Intel</span><span class=p>(</span><span class=n>R</span><span class=p>)</span> <span class=n>I211</span> <span class=n>Gigabit</span><span class=p>...</span>      <span class=mf>10</span> <span class=n>Up</span>          <span class=mf>1</span> <span class=n>Gbps</span>
</span></span><span class=line><span class=cl><span class=n>Tailscale</span>   <span class=n>Tailscale</span> <span class=n>Tunnel</span>               <span class=mf>9</span> <span class=n>Up</span>        <span class=mf>100</span> <span class=n>Gbps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\&gt;</span> <span class=nb>Get-NetIPInterface</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>InterfaceAlias</span> <span class=o>-EQ</span> <span class=s2>&#34;Tailscale&#34;</span> <span class=o>-or</span> <span class=nv>$_</span><span class=p>.</span><span class=py>InterfaceAlias</span> <span class=o>-EQ</span> <span class=s2>&#34;Ethernet&#34;</span><span class=p>)</span> <span class=o>-and</span> <span class=nv>$_</span><span class=p>.</span><span class=py>AddressFamily</span> <span class=o>-eq</span> <span class=s2>&#34;IPv4&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ifIndex</span> <span class=n>InterfaceAlias</span>  <span class=n>AddressFamily</span> <span class=n>NlMtu</span><span class=p>(</span><span class=n>Bytes</span><span class=p>)</span> <span class=n>InterfaceMetric</span> <span class=n>Dhcp</span>     <span class=n>ConnectionState</span> <span class=n>PolicyStore</span>
</span></span><span class=line><span class=cl><span class=p>-------</span> <span class=p>--------------</span>  <span class=p>-------------</span> <span class=p>------------</span> <span class=p>---------------</span> <span class=p>----</span>     <span class=p>---------------</span> <span class=p>-----------</span>
</span></span><span class=line><span class=cl><span class=mf>10</span>      <span class=n>Ethernet</span>        <span class=n>IPv4</span>                  <span class=mf>1500</span>              <span class=mf>25</span> <span class=n>Enabled</span>  <span class=n>Connected</span>       <span class=n>ActiveStore</span>
</span></span><span class=line><span class=cl><span class=mf>11</span>      <span class=n>Tailscale</span>       <span class=n>IPv4</span>                  <span class=mf>1280</span>               <span class=mf>5</span> <span class=n>Disabled</span> <span class=n>Connected</span>       <span class=n>ActiveStore</span>
</span></span></code></pre></div><p>I only want traffic destined for my <a href=https://tailscale.com/kb/1136/tailnet/>Tailnet</a> to use the Tailscale interface. To ensure Windows chooses the Ethernet interface in all other cases, we just need to increase the Interface Metric on the Tailscale interface to be higher than 25.</p><h3 id=the-fix>The Fix</h3><p>The usual way to change this is in the Control Panel, but if you try to set the Interface Metric manually, Windows won&rsquo;t let you because the Tailscale interface somehow has an &ldquo;empty&rdquo; static IP address set.</p><figure><img src=/posts/windows-smb-tailscale/manual-metric.png alt="Windows error message window showing text 'The adapter requires at least one IP address. Please enter one.'"></figure><p>Powershell to the rescue:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>system32</span><span class=p>&gt;</span> <span class=nb>Get-NetAdapter</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=n>-FilterScript</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>InterfaceAlias</span> <span class=o>-Eq</span> <span class=s2>&#34;Tailscale&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Set-NetIPInterface</span> <span class=n>-InterfaceMetric</span> <span class=mf>500</span>
</span></span><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>system32</span><span class=p>&gt;</span> <span class=nb>Get-NetIPInterface</span> <span class=p>|</span><span class=nb>Where-Object</span> <span class=p>{</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>InterfaceAlias</span> <span class=o>-EQ</span> <span class=s2>&#34;Tailscale&#34;</span> <span class=o>-or</span> <span class=nv>$_</span><span class=p>.</span><span class=py>InterfaceAlias</span> <span class=o>-EQ</span> <span class=s2>&#34;Ethernet&#34;</span><span class=p>)</span> <span class=o>-and</span> <span class=nv>$_</span><span class=p>.</span><span class=py>AddressFamily</span> <span class=o>-eq</span> <span class=s2>&#34;IPv4&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ifIndex</span> <span class=n>InterfaceAlias</span> <span class=n>AddressFamily</span> <span class=n>NlMtu</span><span class=p>(</span><span class=n>Bytes</span><span class=p>)</span> <span class=n>InterfaceMetric</span> <span class=n>Dhcp</span>     <span class=n>ConnectionState</span> <span class=n>PolicyStore</span>
</span></span><span class=line><span class=cl><span class=p>-------</span> <span class=p>--------------</span> <span class=p>-------------</span> <span class=p>------------</span> <span class=p>---------------</span> <span class=p>----</span>     <span class=p>---------------</span> <span class=p>-----------</span>
</span></span><span class=line><span class=cl><span class=mf>10</span>      <span class=n>Ethernet</span>       <span class=n>IPv4</span>                  <span class=mf>1500</span>              <span class=mf>25</span> <span class=n>Enabled</span>  <span class=n>Connected</span>       <span class=n>ActiveStore</span>
</span></span><span class=line><span class=cl><span class=mf>9</span>       <span class=n>Tailscale</span>      <span class=n>IPv4</span>                  <span class=mf>1280</span>             <span class=mf>500</span> <span class=n>Disabled</span> <span class=n>Connected</span>       <span class=n>ActiveStore</span>
</span></span></code></pre></div><p>After I changed this, I was back to getting near-gigabit speeds over the Ethernet interface.</p><figure><img src=/posts/windows-smb-tailscale/fast.png alt="Copy progress dialog window showing a speed of 113MB/s"></figure><h3 id=future-steps>Future Steps</h3><p>Switch this machine to a Linux distro and upgrade the NIC to 10G!</p></main></body></html>