<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Moving ZFS datasets between volumes | Dan [the] Salmon</title><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Posts" href=/posts/index.xml><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Links" href=/links/index.xml><link rel=me href=https://infosec.exchange/@dan name=Mastodon><link rel=me href=https://github.com/sa7mon name=GitHub><link rel=stylesheet href=/combined.min.ee4cc4c893778ba3fd302816f523b9af2e95025ab46b5f5014501bf6e9b58b6a.css integrity="sha256-7kzEyJN3i6P9MCgW9SO5ry6VAlq0a19QFFAb9um1i2o=" crossorigin=anonymous></head><body><header><div class=header-container><a class=brand href=/>Dan [the] Salmon</a><nav><ul><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/links/>Links</a></li><li><a href=/contact/>Contact</a></li></ul></nav></div></header><main class=page><p>If you run ZFS like I do (and I think you should) there will probably come at time when you need to migrate a dataset from one volume to another. This was done in FreeNAS (FreeBSD), but the steps should apply to any *nix system with ZFS</p><p>The great thing about ZFS is that we can do most of this migration with our services and everything still running.</p><p>We&rsquo;ll start by taking a snapshot of the dataset we want to move.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zfs snapshot oldpool/mydataset@snapshot1
</span></span></code></pre></div><p>Then we&rsquo;ll copy over the dataset to the new volume. If you have a large dataset you may want to run this command in a <strong>screen</strong> or <strong>tmux</strong> session. You can still use the old dataset while this is running.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zfs send oldpool/mydataset@snapshot1 <span class=p>|</span> zfs receive newpool/mydataset
</span></span></code></pre></div><p>After this is done, turn off all jails and file shares that access the old volume. Then we take a second snapshot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zfs snapshot oldpool/mydataset@snapshot2
</span></span></code></pre></div><p>Now we can do an &ldquo;incremental&rdquo; send that will just copy over the difference between this snapshot and the first. Should be much quicker than the first send</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>zfs send -i oldpool/mydataset@snapshot1 oldpool/mydataset@snapshot2 <span class=p>|</span> zfs receive newpool/mydataset
</span></span></code></pre></div><p>After this send is done, you should be good to go. Make sure to point your file shares and jail storage sources to the new location. Because we used <strong>zfs send</strong>, all the permissions and metadata will be the exact same on the other end.</p></main></body></html>