<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Cracking a Locked Apple Note | Dan [the] Salmon</title><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Posts" href=/posts/index.xml><link rel=alternate type=application/rss+xml title="Dan [the] Salmon: Links" href=/links/index.xml><link rel=me href=https://infosec.exchange/@dan name=Mastodon><link rel=me href=https://github.com/sa7mon name=GitHub><link rel=stylesheet href=/combined.min.ee4cc4c893778ba3fd302816f523b9af2e95025ab46b5f5014501bf6e9b58b6a.css integrity="sha256-7kzEyJN3i6P9MCgW9SO5ry6VAlq0a19QFFAb9um1i2o=" crossorigin=anonymous></head><body><header><div class=header-container><a class=brand href=/>Dan [the] Salmon</a><nav><ul><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li><li><a href=/links/>Links</a></li><li><a href=/contact/>Contact</a></li></ul></nav></div></header><main class=page><time class=pub-date datetime=2024-03-06T00:00:00+00:00>March 6, 2024</time><h1 class=title>Cracking a Locked Apple Note</h1><div class=tags><a href=/tags/cracking/>Cracking</a>
<a href=/tags/apple-notes/>Apple-Notes</a></div><p>There is a note in Apple Notes on my phone that I cannot open.</p><p>The note is not mission critical (gift ideas for my family members), but I would like to have access to it again. I created the note September 21, 2022 and at some point thought it would be funny to put an additional password on a note that contains such trivial information. Some time in the last 6 months, something changed with the note. I used to be able to use TouchID to unlock it, but it began prompting me for a password. Having set it more than a year prior and never having entered it again (to my recollection), I could not remember what it was. I tried all the simple &ldquo;dumb&rdquo; passwords I use when temporarily setting up user accounts, but could not get in.</p><p>What is a hacker to do when they&rsquo;ve forgotten their own password?</p><p>I started searching online for guides on how to &ldquo;crack apple notes password&rdquo;. I found that <a href=https://hashcat.net/hashcat/>hashcat</a> has support for cracking &ldquo;Apple Secure Notes&rdquo; hashes. I am very familiar with hashcat so this was great news, but I didn&rsquo;t know how to extract a hash from my iPhone - this sounded like something that would require a jailbroken phone.</p><p>Eventually I came across <a href=https://www.ciofecaforensics.com/2020/07/31/apple-notes-revisited-encrypted-notes/>this in-depth research</a> into Apple Notes encryption by Jon Baumann of Ciofeca Forensics. The article introduces a tool called <a href=https://github.com/threeplanetssoftware/apple_cloud_notes_parser>Apple Cloud Notes Parser</a> which ingests an iPhone backup (made by iTunes) and produces plaintext files of all the contained Apple Notes. One of the flags it has is <code>--password-file</code> - this is a file of passwords to try when decrypting any encrypted notes.</p><p>I already had a full local backup of my phone, but I encrypt my backups so I had to disable this option and run a new full backup. This took quite a while as the backup was 200GB (256GB capacity iPhone). After it had finally completed, I ran the parser script without any password-file to see what would happen. The tool creates a whole bunch of files including HTML versions of each note, extracted images, and a <code>NoteStore.sqlite</code> database.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>│ debug_log.txt
</span></span><span class=line><span class=cl>│ Manifest.db
</span></span><span class=line><span class=cl>│ notes.sqlite
</span></span><span class=line><span class=cl>│ NoteStore.sqlite
</span></span><span class=line><span class=cl>├───csv
</span></span><span class=line><span class=cl>│       note_store_accounts_1.csv
</span></span><span class=line><span class=cl>│       note_store_accounts_2.csv
</span></span><span class=line><span class=cl>│       note_store_cloudkit_participants_1.csv
</span></span><span class=line><span class=cl>│       note_store_cloudkit_participants_2.csv
</span></span><span class=line><span class=cl>│       note_store_embedded_objects_1.csv
</span></span><span class=line><span class=cl>│       note_store_embedded_objects_2.csv
</span></span><span class=line><span class=cl>│       note_store_folders_1.csv
</span></span><span class=line><span class=cl>│       note_store_folders_2.csv
</span></span><span class=line><span class=cl>│       note_store_notes_1.csv
</span></span><span class=line><span class=cl>│       note_store_notes_2.csv
</span></span><span class=line><span class=cl>├───files
</span></span><span class=line><span class=cl>│   ├───Media
</span></span><span class=line><span class=cl>│   │   └───F0FC4CFE-E5A9-4F7E-BF3C-3425B06A55BF
</span></span><span class=line><span class=cl>│   │           B6BB473B-02E1-4990-8769-185D2E78EDC1.jpg
</span></span><span class=line><span class=cl>│   └───Previews
</span></span><span class=line><span class=cl>│           19239C6C-864E-4A28-9220-696E81B421B3-1-768x768-1.png
</span></span><span class=line><span class=cl>├───html
</span></span><span class=line><span class=cl>│       all_notes_1.html
</span></span><span class=line><span class=cl>│       all_notes_2.html
</span></span><span class=line><span class=cl>└───json
</span></span><span class=line><span class=cl>        all_notes_1.json
</span></span><span class=line><span class=cl>        all_notes_2.json
</span></span></code></pre></div><p>I looked for the encrypted note contents, but the parser of course didn&rsquo;t know what to do with it.</p><p><img src=locked-note.png alt=locked-note></p><p>Trying again to recall my password, I figured that I had probably used a dumb password since the note was not important. Chances were pretty good I had used that password for things like temporarily spinning up services in my homelab. If I had, there was a chance it was saved in my 1Password vault so I exported all the account data from my 1Password account to a CSV, then used <a href=https://github.com/johnkerl/miller><code>miller</code></a> to filter down to just the passwords.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mlr --csv cut -f Password 1PasswordExport.csv &gt;&gt; passwords.txt
</span></span></code></pre></div><p>I re-ran <code>apple_cloud_notes_parser</code> with the password file but had no luck.</p><p>At this point my thoughts turned towards traditional password cracking. How could I extract a hash from this backup that I could then feed to a cracking tool? As usual, it turns out there&rsquo;s a john script for that: <a href=https://github.com/openwall/john/blob/bleeding-jumbo/run/applenotes2john.py><code>applenotes2john.py</code></a>. This worked perfectly to extract a John-compatible hash from <code>NoteStore.sqlite</code>, but I am much more experienced with using hashcat so I tried pointing hashcat at it but got an error message about the hash format.</p><p>I tried changing the hash to match the example listed on the <a href="https://hashcat.net/wiki/doku.php?id=example_hashes"><code>example_hashes</code></a> page, but couldn&rsquo;t get past the <code>Separator unmatched</code> error.</p><p>To make sure the hash was valid, I then downloaded a binary of John which had no trouble with it. To crack the password, I opted for a Mask Attack. I figured that I probably set a really simple password of between 4 and 6 characters of alphanumeric and maybe 1 or 2 special characters. I launched a test run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\john.exe --mask=&#39;?a?a?a?a&#39; H:\Sync\hashes.txt
</span></span></code></pre></div><p>One of the advantages of john over hashcat is the commands are generally much shorter. I was soon reminded why I never use John on this machine - it doesn&rsquo;t seem to recognize my GPU (Nvidia 1050 Ti) even with Cuda installed. It&rsquo;s probably user error, but as a result John listed an ETA of 15 hours to run through the 4-character keyspace using only the CPU (Ryzen 5 1600).</p><p>I started searching to see how to enable Nvidia GPU support for John, but a lot of the articles I found involved recompiling it from source or copying DLLs around my system. At this point it was around 1AM and I figured I&rsquo;d just let John chug through the night and take another run at making hashcat work in the morning</p><p>The next day I checked the progress and John was patiently waiting with a prize:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>&gt;.</span>\<span class=n>john</span><span class=o>.</span><span class=n>exe</span> <span class=o>--</span><span class=n>mask</span><span class=o>=</span><span class=s1>&#39;?a?a?a?a&#39;</span> <span class=n>H</span><span class=p>:</span>\<span class=n>Sync</span>\<span class=n>hashes</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=n>Warning</span><span class=p>:</span> <span class=n>detected</span> <span class=nb>hash</span> <span class=n>type</span> <span class=s2>&#34;notes&#34;</span><span class=p>,</span> <span class=n>but</span> <span class=n>the</span> <span class=n>string</span> <span class=n>is</span> <span class=n>also</span> <span class=n>recognized</span> <span class=n>as</span> <span class=s2>&#34;notes-opencl&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Use</span> <span class=n>the</span> <span class=s2>&#34;--format=notes-opencl&#34;</span> <span class=n>option</span> <span class=n>to</span> <span class=n>force</span> <span class=n>loading</span> <span class=n>these</span> <span class=n>as</span> <span class=n>that</span> <span class=n>type</span> <span class=n>instead</span>
</span></span><span class=line><span class=cl><span class=n>Using</span> <span class=n>default</span> <span class=n>input</span> <span class=n>encoding</span><span class=p>:</span> <span class=n>UTF</span><span class=o>-</span><span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>Loaded</span> <span class=mi>1</span> <span class=n>password</span> <span class=nb>hash</span> <span class=p>(</span><span class=n>notes</span><span class=p>,</span> <span class=n>Apple</span> <span class=n>Notes</span> <span class=p>[</span><span class=n>PBKDF2</span><span class=o>-</span><span class=n>SHA256</span> <span class=n>AES</span> <span class=mi>256</span><span class=o>/</span><span class=mi>256</span> <span class=n>AVX2</span> <span class=mi>8</span><span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>Cost</span> <span class=mi>1</span> <span class=p>(</span><span class=n>iteration</span> <span class=n>count</span><span class=p>)</span> <span class=n>is</span> <span class=mi>20000</span> <span class=k>for</span> <span class=n>all</span> <span class=n>loaded</span> <span class=n>hashes</span>
</span></span><span class=line><span class=cl><span class=n>Will</span> <span class=n>run</span> <span class=mi>12</span> <span class=n>OpenMP</span> <span class=n>threads</span>
</span></span><span class=line><span class=cl><span class=n>Press</span> <span class=s1>&#39;q&#39;</span> <span class=ow>or</span> <span class=n>Ctrl</span><span class=o>-</span><span class=n>C</span> <span class=n>to</span> <span class=n>abort</span><span class=p>,</span> <span class=n>almost</span> <span class=n>any</span> <span class=n>other</span> <span class=n>key</span> <span class=k>for</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=mi>0</span><span class=n>g</span> <span class=mi>0</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>37</span> <span class=mf>1.36</span><span class=o>%</span> <span class=p>(</span><span class=n>ETA</span><span class=p>:</span> <span class=mi>15</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>18</span><span class=p>)</span> <span class=mi>0</span><span class=n>g</span><span class=o>/</span><span class=n>s</span> <span class=mi>1458</span><span class=n>p</span><span class=o>/</span><span class=n>s</span> <span class=mi>1458</span><span class=n>c</span><span class=o>/</span><span class=n>s</span> <span class=mi>1458</span><span class=n>C</span><span class=o>/</span><span class=n>s</span> <span class=mi>0</span><span class=n>xge</span><span class=o>..</span><span class=n>mLge</span>
</span></span><span class=line><span class=cl><span class=mi>0</span><span class=n>g</span> <span class=mi>0</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>00</span> <span class=mf>2.02</span><span class=o>%</span> <span class=p>(</span><span class=n>ETA</span><span class=p>:</span> <span class=mi>15</span><span class=p>:</span><span class=mi>10</span><span class=p>:</span><span class=mi>58</span><span class=p>)</span> <span class=mi>0</span><span class=n>g</span><span class=o>/</span><span class=n>s</span> <span class=mi>1441</span><span class=n>p</span><span class=o>/</span><span class=n>s</span> <span class=mi>1441</span><span class=n>c</span><span class=o>/</span><span class=n>s</span> <span class=mi>1441</span><span class=n>C</span><span class=o>/</span><span class=n>s</span> <span class=n>py</span><span class=p>:</span><span class=n>e</span><span class=o>..</span><span class=n>fu</span><span class=p>:</span><span class=n>e</span>
</span></span><span class=line><span class=cl><span class=n>asdf</span>             <span class=p>(</span><span class=n>NoteStore</span><span class=o>.</span><span class=n>sqlite</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=n>g</span> <span class=mi>0</span><span class=p>:</span><span class=mi>05</span><span class=p>:</span><span class=mi>12</span><span class=p>:</span><span class=mi>35</span> <span class=n>DONE</span> <span class=p>(</span><span class=mi>2024</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>02</span> <span class=mi>04</span><span class=p>:</span><span class=mi>42</span><span class=p>)</span> <span class=mf>0.000053</span><span class=n>g</span><span class=o>/</span><span class=n>s</span> <span class=mi>1425</span><span class=n>p</span><span class=o>/</span><span class=n>s</span> <span class=mi>1425</span><span class=n>c</span><span class=o>/</span><span class=n>s</span> <span class=mi>1425</span><span class=n>C</span><span class=o>/</span><span class=n>s</span> <span class=mi>5</span><span class=n>ndf</span><span class=o>..</span><span class=n>u0df</span>
</span></span><span class=line><span class=cl><span class=n>Use</span> <span class=n>the</span> <span class=s2>&#34;--show&#34;</span> <span class=n>option</span> <span class=n>to</span> <span class=n>display</span> <span class=n>all</span> <span class=n>of</span> <span class=n>the</span> <span class=n>cracked</span> <span class=n>passwords</span> <span class=n>reliably</span>
</span></span><span class=line><span class=cl><span class=n>Session</span> <span class=n>completed</span>
</span></span></code></pre></div><p>Wow, the password I chose was even dumber than I thought!</p><p>Out of curiosity, I looked back at my attempts to use hashcat and realized the other dumb mistake I made - I had mistakenly used mode <code>-m 16500</code> (JWT - JSON Web Token) instead of <code>-m 16200</code> (Apple Secure Notes) 🤦. I corrected the mistake and hashcat proceeded to crack the hash in 6(!) minutes using the GPU.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&gt; .\hashcat.exe -m 16200 H:\Sync\hashes_hc.txt --session apple-notes --status -w 3 -a 3 &#34;?a?a?a?a&#34;
</span></span><span class=line><span class=cl>hashcat (v6.2.6) starting
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ASN$*107*20000*86e7184911aa4090f24d7e701b5c6b05*ddfde252d699d22125c1089338f097f529e79fd2f8acb576:asdf
</span></span><span class=line><span class=cl>Session..........: apple-notes
</span></span><span class=line><span class=cl>Status...........: Cracked
</span></span><span class=line><span class=cl>Hash.Mode........: 16200 (Apple Secure Notes)
</span></span><span class=line><span class=cl>Hash.Target......: $ASN$*107*20000*86e7184911aa4090f24d7e701b5c6b05*dd...acb576
</span></span><span class=line><span class=cl>Time.Started.....: Sat Mar 02 09:05:25 2024 (6 mins, 24 secs)
</span></span><span class=line><span class=cl>Time.Estimated...: Sat Mar 02 09:11:49 2024 (0 secs)
</span></span><span class=line><span class=cl>Kernel.Feature...: Pure Kernel
</span></span><span class=line><span class=cl>Guess.Mask.......: ?a?a?a?a [4]
</span></span><span class=line><span class=cl>Guess.Queue......: 1/1 (100.00%)
</span></span><span class=line><span class=cl>Speed.#1.........:    18628 H/s (66.29ms) @ Accel:4 Loops:1024 Thr:1024 Vec:1
</span></span><span class=line><span class=cl>Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
</span></span><span class=line><span class=cl>Progress.........: 7151616/81450625 (8.78%)
</span></span><span class=line><span class=cl>Rejected.........: 0/7151616 (0.00%)
</span></span><span class=line><span class=cl>Restore.Point....: 73728/857375 (8.60%)
</span></span><span class=line><span class=cl>Restore.Sub.#1...: Salt:0 Amplifier:5-6 Iteration:19456-19999
</span></span><span class=line><span class=cl>Candidate.Engine.: Device Generator
</span></span><span class=line><span class=cl>Candidates.#1....: a2jm -&gt; a+(0
</span></span><span class=line><span class=cl>Hardware.Mon.#1..: Temp: 82c Fan: 49% Util:100% Core:1670MHz Mem:3504MHz Bus:16
</span></span><span class=line><span class=cl>Started: Sat Mar 02 09:05:21 2024
</span></span><span class=line><span class=cl>Stopped: Sat Mar 02 09:11:50 2024
</span></span></code></pre></div><p>I punched in the password and was greeted with my years old list of christmas gift ideas which I will not share here because they&rsquo;re classified. Success!</p></main></body></html>